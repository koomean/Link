<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Links</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0f0c29;
            --card-bg: rgba(255, 255, 255, 0.08);
            --text-color: #ffffff;
            --accent: #00d2ff;
            --navbar-height: 60px;
        }
        body {
            font-family: 'Kanit', sans-serif;
            margin: 0;
            min-height: 100vh;
            background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: calc(var(--navbar-height) + 30px);
            padding-bottom: 40px;
        }

        /* --- Navbar --- */
        .navbar {
            position: fixed; top: 0; left: 0; width: 100%; height: var(--navbar-height);
            background: rgba(15, 12, 41, 0.95); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 15px; box-sizing: border-box; z-index: 1000;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .nav-left { display: flex; align-items: center; gap: 15px; }
        
        .nav-logo {
            font-size: 1.1rem; font-weight: 600; color: #fff; text-decoration: none;
            display: flex; align-items: center; gap: 8px; white-space: nowrap;
        }
        .nav-logo i { color: var(--accent); }
        .nav-logo span { background: linear-gradient(90deg, #fff, var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        /* --- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Dropdown Apps --- */
        .dropdown { position: relative; display: inline-block; }
        
        .dropbtn {
            color: rgba(255,255,255,0.8); cursor: pointer; font-size: 0.9rem; font-weight: 500;
            padding: 8px 12px; border-radius: 8px; transition: 0.3s; display: flex; align-items: center; gap: 5px;
            user-select: none; /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏∏‡∏°‡∏î‡∏≥‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏ï‡∏∞ */
        }
        .dropbtn:active, .dropbtn.active { background: rgba(255,255,255,0.15); color: #fff; }
        
        .dropdown-content {
            display: none; 
            position: absolute; 
            top: 100%; 
            left: 0;
            margin-top: 2px; /* ‡∏•‡∏î‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î */
            background-color: #1e1e2f; 
            min-width: 180px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.6); 
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1); 
            overflow: hidden; 
            z-index: 1001;
        }
        
        /* ‡πÄ‡∏û‡∏¥‡πà‡∏° class ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π (‡πÉ‡∏ä‡πâ JS ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°) */
        .dropdown-content.show { display: block; animation: fadeInMenu 0.2s ease; }
        
        @keyframes fadeInMenu { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .dropdown-content a {
            color: #e0e0e0; padding: 12px 16px; text-decoration: none; display: block; font-size: 0.9rem; 
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .dropdown-content a:last-child { border-bottom: none; }
        .dropdown-content a:hover { background-color: var(--accent); color: #000; }

        /* Right Side */
        .nav-right { display: flex; align-items: center; gap: 10px; }
        
        .nav-clock {
            font-family: monospace; font-weight: bold; font-size: 0.85rem;
            color: var(--accent); background: rgba(0,0,0,0.3); padding: 4px 8px; border-radius: 6px;
            border: 1px solid rgba(0, 210, 255, 0.3); white-space: nowrap;
        }

        .nav-profile-img {
            width: 34px; height: 34px; border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.2);
            object-fit: cover; cursor: pointer; transition: transform 0.3s; background: #fff;
        }

        /* Content Styles (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) */
        .profile-section { text-align: center; margin-bottom: 25px; animation: fadeIn 0.8s ease; }
        .profile-img {
            width: 110px; height: 110px; border-radius: 50%;
            border: 3px solid var(--accent); padding: 4px; object-fit: cover;
            margin-bottom: 15px; box-shadow: 0 0 30px rgba(0, 210, 255, 0.3);
        }
        h1 { margin: 0; font-size: 1.6rem; font-weight: 600; }
        p.bio { opacity: 0.7; margin-top: 5px; font-weight: 300; font-size: 0.9rem; }

        .video-container { width: 95%; max-width: 500px; margin-bottom: 20px; display: none; }
        .video-wrapper { position: relative; padding-bottom: 56.25%; height: 0; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); background: #000; }
        .video-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 12px; }

        .container { width: 95%; max-width: 500px; padding-bottom: 60px; display: flex; flex-direction: column; gap: 12px; }
        
        .link-card {
            background: var(--card-bg); backdrop-filter: blur(10px); padding: 15px 20px;
            border-radius: 14px; text-decoration: none; color: white; display: flex; align-items: center;
            border: 1px solid rgba(255,255,255,0.1); transition: all 0.2s ease;
        }
        .link-card:active { transform: scale(0.98); }
        .link-card.special-access { background: rgba(0, 210, 255, 0.1); border-color: var(--accent); }
        
        .group-divider { display: flex; align-items: center; color: var(--accent); font-size: 0.85rem; margin: 10px 0 5px 0; }
        .group-divider::before, .group-divider::after { content: ''; flex: 1; height: 1px; background: rgba(255,255,255,0.15); }
        .group-divider span { padding: 0 10px; }

        .link-icon { font-size: 1.4rem; margin-right: 15px; width: 30px; text-align: center; }
        .fa-facebook { color: #1877F2; } .fa-youtube { color: #FF0000; } .fa-instagram { color: #E4405F; }
        .fa-line { color: #00C300; } .fa-tiktok { color: #ff0050; filter: drop-shadow(1px 1px 0px #00f2ea); }
        .fa-google-drive { color: #1FA463; } .fa-github { color: #ffffff; } .fa-envelope { color: #FFC107; }
        .fa-link { color: var(--accent); }
        .link-text { font-size: 1rem; font-weight: 500; }
        .badge { margin-left: auto; font-size: 0.7rem; padding: 3px 8px; border-radius: 10px; text-transform: uppercase; }
        .badge-vip { background: linear-gradient(45deg, #FFD700, #FFA500); color: #000; }

        .unlock-btn {
            position: fixed; bottom: 20px; right: 20px; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px);
            color: #aaa; border: 1px solid rgba(255,255,255,0.1); border-radius: 50%; width: 45px; height: 45px;
            display: flex; justify-content: center; align-items: center; transition: 0.3s; z-index: 100;
        }
        .unlock-btn.active { color: #00d2ff; border-color: #00d2ff; background: rgba(0, 210, 255, 0.1); }
        .admin-link { margin-top: auto; color: rgba(255,255,255,0.2); text-decoration: none; font-size: 0.8rem; padding-bottom: 20px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Responsive Adjustments */
        @media (max-width: 400px) {
            .nav-logo span { display: none; } /* ‡∏ã‡πà‡∏≠‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÄ‡∏•‡πá‡∏Å‡πÜ */
            .dropbtn { font-size: 0.85rem; padding: 6px 10px; }
            .nav-clock { font-size: 0.75rem; padding: 3px 6px; }
        }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="nav-left">
            <a href="#" class="nav-logo">
                <i class="fas fa-link"></i>
                <span>Koo Mean</span>
            </a>
            
            <div class="dropdown">
                <div class="dropbtn" onclick="toggleDropdown()">
                    <i class="fas fa-th-large"></i> ‡πÅ‡∏≠‡∏õ <i class="fas fa-chevron-down" style="font-size:0.7rem;"></i>
                </div>
                <div class="dropdown-content" id="apps-dropdown-list">
                    </div>
            </div>
        </div>
        
        <div class="nav-right">
            <div class="nav-clock" id="nav-clock">00:00</div>
            <div class="nav-user-container" onclick="window.location.href='admin.html'">
                <img id="nav-profile-img" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" class="nav-profile-img" alt="User">
            </div>
        </div>
    </nav>

    <div class="profile-section" id="profile-section"></div>

    <div class="video-container" id="featured-video">
        <div class="video-wrapper">
            <iframe id="youtube-iframe" src="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
        </div>
    </div>

    <div class="container" id="links-container">
        <div style="text-align: center; opacity: 0.5;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
    </div>

    <a href="admin.html" class="admin-link"><i class="fas fa-cog"></i> Manage</a>

    <button class="unlock-btn" id="unlockBtn" onclick="handleUnlock()">
        <i class="fas fa-lock"></i>
    </button>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        // ‚ö†Ô∏è ‡πÉ‡∏™‡πà Config ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
        const firebaseConfig = {
            apiKey: "AIzaSyB-Brx6cQ7dFhQqbEhDG4xIT4jcVG1yogs",
  authDomain: "mylinks-web.firebaseapp.com",
  projectId: "mylinks-web",
  storageBucket: "mylinks-web.firebasestorage.app",
  messagingSenderId: "702413304222",
  appId: "1:702413304222:web:d255e6c2f428bb1e1d668f",
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let currentAccessGroup = 'public';
        let accessRules = {};
        let adminProfileImage = '';
        let userImagesMap = {};

        // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° Dropdown (‡πÅ‡∏Å‡πâ‡∏ö‡∏±‡πä‡∏Å‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ & ‡πÄ‡∏°‡∏≤‡∏™‡πå‡∏´‡∏•‡∏∏‡∏î) ---
        function toggleDropdown() {
            document.getElementById("apps-dropdown-list").classList.toggle("show");
            document.querySelector(".dropbtn").classList.toggle("active");
        }

        // ‡∏õ‡∏¥‡∏î Dropdown ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏∑‡πà‡∏ô
        window.onclick = function(event) {
            if (!event.target.closest('.dropdown')) { // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏î‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏ß Dropdown
                var dropdowns = document.getElementsByClassName("dropdown-content");
                var btn = document.querySelector(".dropbtn");
                for (var i = 0; i < dropdowns.length; i++) {
                    var openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                        btn.classList.remove('active');
                    }
                }
            }
        }

        // --- Clock ---
        function updateClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('nav-clock').innerText = timeString;
        }
        setInterval(updateClock, 1000);
        updateClock();

        // --- Load Data ---
        function loadData() {
            db.doc("settings/profile").get().then((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    renderProfile(data);
                    renderVideo(data.featuredVideo);
                    adminProfileImage = data.navbarAdminImage;
                    
                    if (data.appsConfig) renderAppsMenu(data.appsConfig);
                    else document.getElementById('apps-dropdown-list').innerHTML = '<a href="#" style="color:#aaa;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏≠‡∏õ</a>';

                    if (data.userImagesConfig) {
                        data.userImagesConfig.split('\n').forEach(line => {
                            const splitIndex = line.indexOf(':');
                            if (splitIndex > 0) {
                                const key = line.substring(0, splitIndex).trim();
                                const url = line.substring(splitIndex + 1).trim();
                                if(key && url) userImagesMap[key] = url;
                            }
                        });
                    }

                    if (data.accessConfig) {
                        data.accessConfig.split('\n').forEach(line => {
                            const [code, group] = line.split(':');
                            if(code && group) accessRules[code.trim()] = group.trim();
                        });
                    }
                    checkAuthStatus();
                }
            });

            db.collection("links").orderBy("order", "asc").get().then((snapshot) => {
                const container = document.getElementById('links-container');
                container.innerHTML = ''; 
                let allLinks = [];
                snapshot.forEach(doc => allLinks.push(doc.data()));

                const visibleLinks = allLinks.filter(link => {
                    const groupString = link.group || 'public';
                    const allowedGroups = groupString.split(',').map(g => g.trim());
                    return allowedGroups.includes('public') || allowedGroups.includes(currentAccessGroup);
                });

                const specialLinks = visibleLinks.filter(link => {
                    const groupString = link.group || 'public';
                    const allowedGroups = groupString.split(',').map(g => g.trim());
                    return !allowedGroups.includes('public') && allowedGroups.includes(currentAccessGroup);
                });
                
                const publicLinks = visibleLinks.filter(link => {
                     const groupString = link.group || 'public';
                     return groupString.includes('public');
                });

                if (specialLinks.length > 0) {
                    container.innerHTML += `<div class="group-divider"><span>üîì ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏û‡∏¥‡πÄ‡∏®‡∏©: ${currentAccessGroup.toUpperCase()}</span></div>`;
                    specialLinks.forEach(link => renderLink(container, link, true));
                }
                if (publicLinks.length > 0) {
                    if (specialLinks.length > 0) container.innerHTML += `<div class="group-divider"><span>üåç ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞</span></div>`;
                    publicLinks.forEach(link => renderLink(container, link, false));
                }
            });
        }

        function renderAppsMenu(configStr) {
            const menuContainer = document.getElementById('apps-dropdown-list');
            menuContainer.innerHTML = ''; 
            configStr.split('\n').forEach(line => {
                const parts = line.split('|');
                if(parts.length >= 2) {
                    const name = parts[0].trim();
                    const url = parts[1].trim();
                    menuContainer.innerHTML += `<a href="${url}" target="_blank">${name}</a>`;
                }
            });
        }

        function checkAuthStatus() { const user = auth.currentUser; updateNavbarUI(user); }
        auth.onAuthStateChanged((user) => { updateNavbarUI(user); });

        function updateNavbarUI(user) {
            const navImg = document.getElementById('nav-profile-img');
            if (user) {
                if (userImagesMap[user.email]) navImg.src = userImagesMap[user.email];
                else if (adminProfileImage) navImg.src = adminProfileImage;
                else navImg.src = user.photoURL || `https://ui-avatars.com/api/?name=${user.email}&background=random`;
                navImg.style.borderColor = "#00d2ff";
            } else {
                if (currentAccessGroup !== 'public' && userImagesMap[currentAccessGroup]) {
                    navImg.src = userImagesMap[currentAccessGroup];
                    navImg.style.borderColor = "#ffbd00";
                } else {
                    navImg.src = "https://cdn-icons-png.flaticon.com/512/149/149071.png"; 
                    navImg.style.borderColor = "rgba(255,255,255,0.2)";
                }
            }
        }

        function renderProfile(data) {
            document.getElementById('profile-section').innerHTML = `
                <img src="${data.imageUrl || 'https://ui-avatars.com/api/?name=User'}" class="profile-img">
                <h1>${data.name || 'My Links'}</h1>
                <p class="bio">${data.bio || ''}</p>
            `;
        }

        function renderVideo(url) {
            const videoContainer = document.getElementById('featured-video');
            const iframe = document.getElementById('youtube-iframe');
            if (url) {
                const videoId = extractVideoID(url);
                if (videoId) {
                    iframe.src = `https://www.youtube.com/embed/${videoId}`;
                    videoContainer.style.display = 'block';
                } else { videoContainer.style.display = 'none'; }
            } else { videoContainer.style.display = 'none'; }
        }

        function extractVideoID(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        function renderLink(container, link, isSpecial) {
            const iconClass = link.icon || 'fas fa-link';
            const specialClass = isSpecial ? 'special-access' : '';
            const badge = isSpecial ? `<span class="badge badge-vip">${currentAccessGroup}</span>` : '';
            const html = `
                <a href="${link.url}" target="_blank" class="link-card ${specialClass}">
                    <div class="link-icon"><i class="${iconClass}"></i></div>
                    <div class="link-text">${link.title}</div>
                    ${badge}
                </a>
            `;
            container.innerHTML += html;
        }

        function handleUnlock() {
            if (currentAccessGroup !== 'public') {
                currentAccessGroup = 'public';
                alert("üîí ‡∏•‡πá‡∏≠‡∏Ñ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß");
                document.getElementById('unlockBtn').classList.remove('active');
                document.getElementById('unlockBtn').innerHTML = '<i class="fas fa-lock"></i>';
                updateNavbarUI(null);
                loadData();
            } else {
                const input = prompt("üîë ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á:");
                if (input && accessRules[input]) {
                    currentAccessGroup = accessRules[input];
                    document.getElementById('unlockBtn').classList.add('active');
                    document.getElementById('unlockBtn').innerHTML = '<i class="fas fa-unlock"></i>';
                    updateNavbarUI(null);
                    loadData();
                } else if (input) {
                    alert("‚ùå ‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
                }
            }
        }

        loadData();
    </script>
</body>
</html>
